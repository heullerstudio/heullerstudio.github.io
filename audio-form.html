<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Audio Form — Heuller Studio</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --white: #f7f6f3;
      --ink: #111110;
      --mid: #6b6a68;
      --faint: #d8d6d2;
      --orange: #e55a1c;
      --f: 'Hanken Grotesk', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }
    @import url('https://fonts.googleapis.com/css2?family=Hanken+Grotesk:wght@300;400;500&display=swap');

    html, body {
      height: 100%;
      background: var(--ink);
      color: var(--white);
      font-family: var(--f);
      font-size: 12px;
      font-weight: 300;
      -webkit-font-smoothing: antialiased;
      overflow: hidden;
    }

    /* NAV */
    nav {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 48px;
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: stretch;
      border-bottom: 1px solid rgba(247,246,243,0.12);
      z-index: 100;
    }
    .nav-brand {
      display: flex;
      align-items: center;
      padding: 0 1.5rem;
      font-size: 10px;
      font-weight: 500;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: rgba(247,246,243,0.4);
    }
    .nav-brand a {
      color: inherit;
      text-decoration: none;
    }
    .nav-brand span {
      color: rgba(247,246,243,0.15);
      margin: 0 0.6rem;
    }
    .nav-title {
      color: rgba(247,246,243,0.9);
    }

    /* CANVAS */
    canvas {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
    }

    /* BOTTOM UI */
    .ui {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      height: 60px;
      display: grid;
      grid-template-columns: auto 1fr auto auto;
      align-items: stretch;
      border-top: 1px solid rgba(247,246,243,0.12);
      z-index: 100;
    }
    .ui-cell {
      display: flex;
      align-items: center;
      padding: 0 1.5rem;
      border-right: 1px solid rgba(247,246,243,0.08);
      gap: 0.8rem;
    }
    .ui-cell:last-child { border-right: none; }
    .ui-label {
      font-size: 9px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: rgba(247,246,243,0.3);
    }
    .ui-value {
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.06em;
      color: rgba(247,246,243,0.8);
      min-width: 3ch;
    }

    /* MIC BUTTON */
    .mic-btn {
      background: none;
      border: 1px solid rgba(247,246,243,0.2);
      color: rgba(247,246,243,0.6);
      font-family: var(--f);
      font-size: 9px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      padding: 0 1.8rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }
    .mic-btn:hover {
      border-color: rgba(247,246,243,0.5);
      color: var(--white);
    }
    .mic-btn.active {
      border-color: var(--orange);
      color: var(--orange);
    }
    .mic-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
      flex-shrink: 0;
    }
    .mic-btn.active .mic-dot {
      animation: pulse 1s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.4; transform: scale(0.6); }
    }

    /* MODE BUTTONS */
    .mode-btns {
      display: flex;
      align-items: center;
      padding: 0 1.5rem;
      gap: 0.5rem;
      border-right: 1px solid rgba(247,246,243,0.08);
    }
    .mode-btn {
      background: none;
      border: 1px solid rgba(247,246,243,0.1);
      color: rgba(247,246,243,0.3);
      font-family: var(--f);
      font-size: 9px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 0.3rem 0.8rem;
      cursor: pointer;
      transition: all 0.15s;
    }
    .mode-btn:hover { color: rgba(247,246,243,0.7); border-color: rgba(247,246,243,0.3); }
    .mode-btn.active { border-color: var(--orange); color: var(--orange); }

    /* VU METER */
    .vu {
      display: flex;
      align-items: center;
      padding: 0 1.5rem;
      gap: 2px;
    }
    .vu-bar {
      width: 3px;
      height: 24px;
      background: rgba(247,246,243,0.06);
      border-radius: 1px;
      position: relative;
      overflow: hidden;
    }
    .vu-fill {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      background: var(--orange);
      transition: height 0.05s;
      border-radius: 1px;
    }

    .source-btns {
      display: flex;
      align-items: center;
      padding: 0 1rem;
      gap: 0.4rem;
      border-right: 1px solid rgba(247,246,243,0.08);
      flex-shrink: 0;
    }
    .source-btn {
      background: none;
      border: 1px solid rgba(247,246,243,0.1);
      color: rgba(247,246,243,0.3);
      font-family: var(--f);
      font-size: 9px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 0.3rem 0.7rem;
      cursor: pointer;
      transition: all 0.15s;
    }
    .source-btn:hover { color: rgba(247,246,243,0.7); border-color: rgba(247,246,243,0.3); }
    .source-btn.active { border-color: var(--orange); color: var(--orange); }
    .source-panel {
      display: flex;
      align-items: center;
      padding: 0 1rem;
      gap: 0.6rem;
      border-right: 1px solid rgba(247,246,243,0.08);
      flex-shrink: 0;
    }
    .file-label {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      cursor: pointer;
      font-size: 9px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: rgba(247,246,243,0.4);
      border: 1px solid rgba(247,246,243,0.15);
      padding: 0 1.2rem;
      height: 36px;
      transition: all 0.15s;
    }
    .file-label:hover { color: rgba(247,246,243,0.8); border-color: rgba(247,246,243,0.4); }
    .file-label.loaded { border-color: var(--orange); color: var(--orange); }
    .play-btn {
      background: none;
      border: 1px solid rgba(247,246,243,0.2);
      color: rgba(247,246,243,0.6);
      font-family: var(--f);
      font-size: 9px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      padding: 0 1rem;
      height: 36px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .play-btn:hover { border-color: var(--orange); color: var(--orange); }
    .play-btn.playing { border-color: var(--orange); color: var(--orange); }
    .url-input {
      background: none;
      border: 1px solid rgba(247,246,243,0.1);
      color: rgba(247,246,243,0.7);
      font-family: var(--f);
      font-size: 9px;
      letter-spacing: 0.06em;
      padding: 0 0.8rem;
      height: 36px;
      width: 240px;
      outline: none;
      transition: border-color 0.15s;
    }
    .url-input:focus { border-color: rgba(247,246,243,0.4); }
    .url-input::placeholder { color: rgba(247,246,243,0.2); }
  </style>
</head>
<body>

<nav>
  <div class="nav-brand">
    <a href="index.html">Heuller Studio</a>
    <span>/</span>
    <span class="nav-title">Audio Form</span>
  </div>
</nav>

<canvas id="c"></canvas>

<div class="ui">
  <div class="source-btns">
    <button class="source-btn active" id="src-mic" onclick="selectSource('mic')">Mic</button>
    <button class="source-btn" id="src-file" onclick="selectSource('file')">File</button>
    <button class="source-btn" id="src-url" onclick="selectSource('url')">URL</button>
    <button class="source-btn" id="src-tab" onclick="selectSource('tab')">Tab</button>
  </div>

  <div class="source-panel" id="panel-mic">
    <button class="mic-btn" id="micBtn" onclick="toggleMic()">
      <span class="mic-dot"></span>
      <span id="micLabel">Enable Mic</span>
    </button>
  </div>

  <div class="source-panel" id="panel-file" style="display:none;">
    <label class="file-label" id="fileLabel">
      <input type="file" id="fileInput" accept="audio/*" onchange="loadFile(this)" style="display:none;">
      <span class="mic-dot" id="fileDot"></span>
      <span id="fileNameDisplay">Drop audio file</span>
    </label>
    <button class="play-btn" id="playBtn" onclick="togglePlay()" style="display:none;">Play</button>
  </div>

  <div class="source-panel" id="panel-url" style="display:none;">
    <input class="url-input" id="urlInput" type="text" placeholder="https://... audio URL" />
    <button class="mic-btn" onclick="loadUrl()">
      <span class="mic-dot" id="urlDot"></span>
      <span>Load</span>
    </button>
    <button class="play-btn" id="urlPlayBtn" onclick="toggleUrlPlay()" style="display:none;">Play</button>
  </div>

  <div class="source-panel" id="panel-tab" style="display:none;">
    <button class="mic-btn" id="tabBtn" onclick="toggleTab()">
      <span class="mic-dot" id="tabDot"></span>
      <span id="tabLabel">Share Tab Audio</span>
    </button>
  </div>

  <div class="mode-btns">
    <button class="mode-btn active" onclick="setMode('blob')" id="mode-blob">Blob</button>
    <button class="mode-btn" onclick="setMode('grid')" id="mode-grid">Grid</button>
    <button class="mode-btn" onclick="setMode('ring')" id="mode-ring">Ring</button>
    <button class="mode-btn" onclick="setMode('wave')" id="mode-wave">Wave</button>
  </div>

  <div class="vu" id="vuMeter"></div>

  <div class="ui-cell">
    <span class="ui-label">Volume</span>
    <span class="ui-value" id="volDisplay">—</span>
  </div>
  <div class="ui-cell">
    <span class="ui-label">Peak</span>
    <span class="ui-value" id="peakDisplay">—</span>
  </div>
</div>

<script>
var canvas = document.getElementById('c');
var ctx = canvas.getContext('2d');
var W, H, cx, cy;

var audioCtx, analyser, dataArray, source;
var micActive = false;
var fileAudio = null, fileSource = null, fileActive = false;
var urlAudio = null, urlSource = null, urlActive = false;
var tabStream = null, tabSource = null, tabActive = false;
var currentSource = 'mic';
var volume = 0;
var smoothVol = 0;
var smoothBass = 0;
var smoothMid = 0;
var smoothTreble = 0;
var peak = 0;
var peakDecay = 0;
var mode = 'blob';
var frame = 0;

// Build VU meter
var vuMeter = document.getElementById('vuMeter');
var vuBars = [];
for (var i = 0; i < 20; i++) {
  var bar = document.createElement('div');
  bar.className = 'vu-bar';
  var fill = document.createElement('div');
  fill.className = 'vu-fill';
  bar.appendChild(fill);
  vuMeter.appendChild(bar);
  vuBars.push(fill);
}

function resize() {
  W = canvas.width = window.innerWidth;
  H = canvas.height = window.innerHeight;
  cx = W / 2;
  cy = H / 2;
}
window.addEventListener('resize', resize);
resize();

function toggleMic() {
  if (micActive) {
    stopMic();
  } else {
    startMic();
  }
}

function startMic() {
  navigator.mediaDevices.getUserMedia({ audio: true, video: false })
    .then(function(stream) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      analyser.smoothingTimeConstant = 0.8;
      dataArray = new Uint8Array(analyser.frequencyBinCount);
      source = audioCtx.createMediaStreamSource(stream);
      source.connect(analyser);
      micActive = true;
      document.getElementById('micBtn').classList.add('active');
      document.getElementById('micLabel').textContent = 'Mic On';
    })
    .catch(function(err) {
      alert('Microphone access denied. Please allow mic access and try again.');
    });
}

function stopMic() {
  if (source) source.disconnect();
  if (audioCtx) audioCtx.close();
  micActive = false;
  volume = 0;
  smoothVol = 0;
  document.getElementById('micBtn').classList.remove('active');
  document.getElementById('micLabel').textContent = 'Enable Mic';
  document.getElementById('volDisplay').textContent = '—';
  document.getElementById('peakDisplay').textContent = '—';
}

function setMode(m) {
  mode = m;
  document.querySelectorAll('.mode-btn').forEach(function(b) { b.classList.remove('active'); });
  document.getElementById('mode-' + m).classList.add('active');
}

function getSpectrum() {
  if (!analyser) return { vol: 0, bass: 0, mid: 0, treble: 0, raw: [] };
  analyser.getByteFrequencyData(dataArray);
  var len = dataArray.length;
  // frequency bands (FFT 2048 = 1024 bins, ~43Hz per bin at 44100Hz)
  var bassEnd   = Math.floor(len * 0.04);   // 0–4%   bass
  var midEnd    = Math.floor(len * 0.25);   // 4–25%  mids
  // treble = rest
  var bass = 0, mid = 0, treble = 0;
  for (var i = 0;       i < bassEnd; i++) bass   += dataArray[i];
  for (var i = bassEnd; i < midEnd;  i++) mid    += dataArray[i];
  for (var i = midEnd;  i < len;     i++) treble += dataArray[i];
  bass   /= bassEnd * 255;
  mid    /= (midEnd - bassEnd) * 255;
  treble /= (len - midEnd) * 255;
  var vol = (bass * 0.5 + mid * 0.35 + treble * 0.15);
  return { vol: vol, bass: bass, mid: mid, treble: treble, raw: dataArray };
}

function getVolume() {
  return getSpectrum().vol;
}

function updateVU(bass, mid, treble) {
  var bands = [bass, bass, bass, bass, bass, bass,
               mid, mid, mid, mid, mid, mid, mid,
               treble, treble, treble, treble, treble, treble, treble];
  for (var i = 0; i < vuBars.length; i++) {
    var v = Math.min(1, bands[i] * 2.5);
    vuBars[i].style.height = (v * 100) + '%';
    var isBass = i < 6, isMid = i < 13;
    vuBars[i].style.background = v > 0.05
      ? (isBass ? 'var(--orange)' : (isMid ? '#d4884a' : '#e8c4a8'))
      : 'rgba(247,246,243,0.06)';
  }
}

function selectSource(src) {
  currentSource = src;
  document.querySelectorAll('.source-btn').forEach(function(b) { b.classList.remove('active'); });
  document.getElementById('src-' + src).classList.add('active');
  document.querySelectorAll('.source-panel').forEach(function(p) { p.style.display = 'none'; });
  document.getElementById('panel-' + src).style.display = 'flex';
}

function loadFile(input) {
  if (!input.files.length) return;
  var file = input.files[0];
  document.getElementById('fileNameDisplay').textContent = file.name.length > 20 ? file.name.substring(0,18)+'...' : file.name;
  document.getElementById('fileLabel').classList.add('loaded');
  document.getElementById('fileDot').style.background = 'var(--orange)';

  if (fileAudio) { fileAudio.pause(); fileAudio.src = ''; }
  fileAudio = new Audio();
  fileAudio.src = URL.createObjectURL(file);
  fileAudio.loop = true;
  document.getElementById('playBtn').style.display = 'flex';
  document.getElementById('playBtn').textContent = 'Play';
  fileActive = false;
}

function togglePlay() {
  if (!fileAudio) return;
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    analyser.smoothingTimeConstant = 0.8;
    dataArray = new Uint8Array(analyser.frequencyBinCount);
  }
  if (audioCtx.state === 'suspended') audioCtx.resume();
  if (!fileSource) {
    fileSource = audioCtx.createMediaElementSource(fileAudio);
    fileSource.connect(analyser);
    analyser.connect(audioCtx.destination);
  }
  if (fileActive) {
    fileAudio.pause();
    fileActive = false;
    document.getElementById('playBtn').textContent = 'Play';
    document.getElementById('playBtn').classList.remove('playing');
  } else {
    fileAudio.play();
    fileActive = true;
    document.getElementById('playBtn').textContent = 'Pause';
    document.getElementById('playBtn').classList.add('playing');
    micActive = true; // reuse mic flag to enable volume reading
  }
}

function loadUrl() {
  var url = document.getElementById('urlInput').value.trim();
  if (!url) return;
  if (urlAudio) { urlAudio.pause(); urlAudio.src = ''; urlSource = null; }
  urlAudio = new Audio();
  urlAudio.crossOrigin = 'anonymous';
  urlAudio.src = url;
  urlAudio.loop = true;
  document.getElementById('urlPlayBtn').style.display = 'flex';
  document.getElementById('urlPlayBtn').textContent = 'Play';
  document.getElementById('urlDot').style.background = 'var(--orange)';
  urlActive = false;
}

function toggleTab() {
  if (tabActive) {
    stopTab();
    return;
  }
  if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
    alert('Tab capture not supported in this browser. Use Chrome or Edge.');
    return;
  }
  navigator.mediaDevices.getDisplayMedia({ video: true, audio: true })
    .then(function(stream) {
      var audioTracks = stream.getAudioTracks();
      if (!audioTracks.length) {
        alert('No audio detected. Make sure to tick "Share tab audio" in the dialog.');
        stream.getTracks().forEach(function(t) { t.stop(); });
        return;
      }
      tabStream = stream;
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;
        analyser.smoothingTimeConstant = 0.8;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
      }
      if (audioCtx.state === 'suspended') audioCtx.resume();
      tabSource = audioCtx.createMediaStreamSource(stream);
      tabSource.connect(analyser);
      tabActive = true;
      micActive = true;
      document.getElementById('tabBtn').classList.add('active');
      document.getElementById('tabDot').style.background = 'var(--orange)';
      document.getElementById('tabLabel').textContent = 'Stop';
      // stop video tracks — we only need audio
      stream.getVideoTracks().forEach(function(t) { t.stop(); });
    })
    .catch(function(err) {
      if (err.name !== 'NotAllowedError') {
        alert('Could not capture tab audio: ' + err.message);
      }
    });
}

function stopTab() {
  if (tabStream) {
    tabStream.getTracks().forEach(function(t) { t.stop(); });
    tabStream = null;
  }
  if (tabSource) { tabSource.disconnect(); tabSource = null; }
  tabActive = false;
  micActive = false;
  document.getElementById('tabBtn').classList.remove('active');
  document.getElementById('tabDot').style.background = '';
  document.getElementById('tabLabel').textContent = 'Share Tab Audio';
}


function toggleUrlPlay() {
  if (!urlAudio) return;
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    analyser.smoothingTimeConstant = 0.8;
    dataArray = new Uint8Array(analyser.frequencyBinCount);
  }
  if (audioCtx.state === 'suspended') audioCtx.resume();
  if (!urlSource) {
    urlSource = audioCtx.createMediaElementSource(urlAudio);
    urlSource.connect(analyser);
    analyser.connect(audioCtx.destination);
  }
  if (urlActive) {
    urlAudio.pause();
    urlActive = false;
    document.getElementById('urlPlayBtn').textContent = 'Play';
    document.getElementById('urlPlayBtn').classList.remove('playing');
    micActive = false;
  } else {
    urlAudio.play().catch(function(e) { alert('Could not load URL. Check CORS or try a different source.'); });
    urlActive = true;
    document.getElementById('urlPlayBtn').textContent = 'Pause';
    document.getElementById('urlPlayBtn').classList.add('playing');
    micActive = true;
  }
}


// ── DRAW MODES ──────────────────────────────────────────────────

function drawBlob(vol, bass, mid, treble) {
  var pts = 180;
  var baseR = Math.min(W, H) * 0.22;
  var t = frame * 0.006;

  // bass drives overall size, mid drives medium freq distortion, treble drives fine detail
  var ampBass   = baseR * 0.7 * bass;
  var ampMid    = baseR * 0.35 * mid;
  var ampTreble = baseR * 0.15 * treble;

  ctx.beginPath();
  for (var i = 0; i <= pts; i++) {
    var angle = (i / pts) * Math.PI * 2;
    var n = 0;
    n += Math.sin(angle * 2 + t * 0.8)  * ampBass;
    n += Math.sin(angle * 3 - t * 1.1)  * ampBass * 0.6;
    n += Math.sin(angle * 5 + t * 1.8)  * ampMid;
    n += Math.sin(angle * 7 - t * 2.4)  * ampMid * 0.5;
    n += Math.sin(angle * 11 + t * 4.0) * ampTreble;
    n += Math.sin(angle * 13 - t * 5.0) * ampTreble * 0.6;
    var r = baseR + n;
    var x = cx + r * Math.cos(angle);
    var y = cy + r * Math.sin(angle);
    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  }
  ctx.closePath();

  var grad = ctx.createRadialGradient(cx, cy, 0, cx, cy, baseR + ampBass);
  var alpha = 0.05 + bass * 0.18;
  grad.addColorStop(0,   'rgba(229, 90, 28, ' + (alpha * 2) + ')');
  grad.addColorStop(0.5, 'rgba(229, 90, 28, ' + alpha + ')');
  grad.addColorStop(1,   'rgba(229, 90, 28, 0)');
  ctx.fillStyle = grad;
  ctx.fill();

  ctx.strokeStyle = 'rgba(247, 246, 243, ' + (0.1 + mid * 0.7 + treble * 0.3) + ')';
  ctx.lineWidth = 0.5 + bass * 2.5 + treble * 1.5;
  ctx.stroke();

  // bass pulse core
  ctx.beginPath();
  ctx.arc(cx, cy, baseR * 0.15 + bass * baseR * 0.35, 0, Math.PI * 2);
  ctx.fillStyle = 'rgba(229, 90, 28, ' + (bass * 0.9) + ')';
  ctx.fill();

  // treble sparkle dots
  if (treble > 0.05) {
    for (var d = 0; d < 8; d++) {
      var da = (d / 8) * Math.PI * 2 + t * 3;
      var dr = baseR * (0.6 + treble * 0.5);
      ctx.beginPath();
      ctx.arc(cx + dr * Math.cos(da), cy + dr * Math.sin(da), 1.5 + treble * 3, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(247, 246, 243, ' + (treble * 0.8) + ')';
      ctx.fill();
    }
  }
}

function drawGrid(vol, bass, mid, treble) {
  var cols = 18, rows = 11;
  var cellW = W / cols, cellH = (H - 108) / rows;
  var offsetY = 48;
  var t = frame * 0.012;

  for (var row = 0; row < rows; row++) {
    for (var col = 0; col < cols; col++) {
      var x = col * cellW + cellW / 2;
      var y = offsetY + row * cellH + cellH / 2;
      var dx = (x - cx) / (W * 0.5);
      var dy = (y - cy) / (H * 0.5);
      var dist = Math.sqrt(dx * dx + dy * dy);

      // bass = ripple speed, mid = wave shape, treble = fine noise
      var bassWave   = Math.sin(dist * 3.5 - t * (2 + bass * 8))   * bass;
      var midWave    = Math.sin(dist * 6   + t * (1.5 + mid * 5))  * mid * 0.6;
      var trebleWave = Math.sin(dist * 12  - t * (4 + treble * 10)) * treble * 0.3;
      var wave = Math.max(0, bassWave + midWave + trebleWave);

      var baseSize = cellW * 0.1;
      var size = baseSize + bass * cellW * 0.35 * (1 - dist * 0.3) + treble * cellW * 0.15;
      size = Math.max(1, size);

      var alpha = 0.05 + wave * 0.5 + bass * 0.3 * (1 - dist * 0.4);

      // color shifts with frequency: bass=orange, mid=warm, treble=white
      var r2 = Math.round(229 * (0.6 + bass * 0.4) + 247 * treble * 0.3);
      var g2 = Math.round(90  * (1 - treble * 0.5));
      var b2 = Math.round(28  * (1 - treble * 0.7) + 243 * treble * 0.2);
      r2 = Math.min(255, r2); g2 = Math.min(255, g2); b2 = Math.min(255, b2);

      ctx.beginPath();
      ctx.arc(x, y, size, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(' + r2 + ',' + g2 + ',' + b2 + ',' + alpha + ')';
      ctx.fill();
    }
  }
}

function drawRing(vol, bass, mid, treble) {
  var rings = 7;
  var baseR = Math.min(W, H) * 0.07;
  var t = frame * 0.005;

  for (var ri = 0; ri < rings; ri++) {
    var ratio = ri / (rings - 1);
    // inner rings = bass, outer rings = treble
    var bandInfluence = ri < 2 ? bass : (ri < 5 ? mid : treble);
    var r = baseR * (1.2 + ri * 1.1) + bass * baseR * 1.8 * (1 - ratio * 0.6);
    var pts = 80 + ri * 20;
    var speed = (ri % 2 === 0 ? 1 : -1) * (0.4 + ri * 0.15);

    // amplitude: bass rings distort more from bass, etc.
    var ampBass   = ri < 3 ? bass   * r * 0.4 : bass   * r * 0.1;
    var ampMid    = ri < 5 ? mid    * r * 0.25 : mid   * r * 0.05;
    var ampTreble = treble * r * (0.05 + ratio * 0.2);

    ctx.beginPath();
    for (var i = 0; i <= pts; i++) {
      var angle = (i / pts) * Math.PI * 2;
      var n = Math.sin(angle * (2 + ri) + t * speed)      * ampBass
            + Math.sin(angle * (4 + ri) - t * speed * 1.5) * ampMid
            + Math.sin(angle * (9 + ri) + t * speed * 3.5) * ampTreble;
      var rad = r + n;
      var x = cx + rad * Math.cos(angle);
      var y = cy + rad * Math.sin(angle);
      if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    }
    ctx.closePath();
    var alpha = (0.06 + bandInfluence * 0.5) * (1 - ratio * 0.3);
    // color: bass rings orange, treble rings white
    var rr = Math.round(229 + (247 - 229) * ratio * treble);
    var gg = Math.round(90  + (246 - 90)  * ratio * treble);
    var bb = Math.round(28  + (243 - 28)  * ratio * treble);
    ctx.strokeStyle = 'rgba(' + rr + ',' + gg + ',' + bb + ',' + alpha + ')';
    ctx.lineWidth = 0.5 + bandInfluence * 2.5;
    ctx.stroke();
  }

  // bass pulse core
  var coreR = 3 + bass * 30;
  ctx.beginPath();
  ctx.arc(cx, cy, coreR, 0, Math.PI * 2);
  var coreGrad = ctx.createRadialGradient(cx, cy, 0, cx, cy, coreR);
  coreGrad.addColorStop(0, 'rgba(229, 90, 28, ' + (0.5 + bass * 0.5) + ')');
  coreGrad.addColorStop(1, 'rgba(229, 90, 28, 0)');
  ctx.fillStyle = coreGrad;
  ctx.fill();
}

function drawWave(vol, bass, mid, treble) {
  var t = frame * 0.018;
  var areaH = H - 108;
  var midY = 48 + areaH / 2;

  // 3 band layers + 2 detail layers
  var layers = [
    { band: bass,   freq: 0.004, speed: 0.8,  yOff: 0,              lw: 2.5, alpha: 0.9 },
    { band: bass,   freq: 0.007, speed: -0.6, yOff: areaH * 0.12,   lw: 1.5, alpha: 0.5 },
    { band: mid,    freq: 0.012, speed: 1.4,  yOff: -areaH * 0.1,   lw: 1.2, alpha: 0.7 },
    { band: mid,    freq: 0.02,  speed: -1.8, yOff: areaH * 0.22,   lw: 0.8, alpha: 0.4 },
    { band: treble, freq: 0.035, speed: 3.0,  yOff: -areaH * 0.22,  lw: 0.5, alpha: 0.6 },
    { band: treble, freq: 0.055, speed: -4.5, yOff: 0,              lw: 0.3, alpha: 0.3 }
  ];

  // draw fill for bass layer
  var bassAmp = 30 + bass * 180;
  ctx.beginPath();
  ctx.moveTo(0, midY);
  for (var x = 0; x <= W; x += 2) {
    var y = midY
      + Math.sin(x * 0.004 + t * 0.8)  * bassAmp
      + Math.sin(x * 0.009 - t * 0.5)  * bassAmp * 0.4;
    ctx.lineTo(x, y);
  }
  ctx.lineTo(W, H); ctx.lineTo(0, H); ctx.closePath();
  var fg = ctx.createLinearGradient(0, midY - bassAmp, 0, midY + bassAmp * 2);
  fg.addColorStop(0, 'rgba(229, 90, 28, ' + (bass * 0.12) + ')');
  fg.addColorStop(1, 'rgba(229, 90, 28, 0)');
  ctx.fillStyle = fg;
  ctx.fill();

  // draw each layer
  for (var li = 0; li < layers.length; li++) {
    var L = layers[li];
    var amp = 20 + L.band * (li < 2 ? 160 : (li < 4 ? 80 : 40));
    ctx.beginPath();
    ctx.moveTo(0, midY + L.yOff);
    for (var x = 0; x <= W; x += 2) {
      var y = midY + L.yOff
        + Math.sin(x * L.freq + t * L.speed) * amp
        + Math.sin(x * L.freq * 2.1 - t * L.speed * 0.7) * amp * 0.35
        + Math.sin(x * L.freq * 0.4 + t * L.speed * 0.3) * amp * 0.2;
      ctx.lineTo(x, y);
    }
    var a = (0.04 + L.band * L.alpha * 0.6);
    // bass=orange, mid=warm, treble=white
    var lc = li < 2 ? 'rgba(229,90,28,' : (li < 4 ? 'rgba(220,140,80,' : 'rgba(247,246,243,');
    ctx.strokeStyle = lc + a + ')';
    ctx.lineWidth = L.lw + L.band * 2.5;
    ctx.stroke();
  }
}

// ── MAIN LOOP ────────────────────────────────────────────────────

function draw() {
  requestAnimationFrame(draw);
  frame++;

  // get spectrum
  var spec = micActive ? getSpectrum() : { vol: 0, bass: 0, mid: 0, treble: 0, raw: [] };
  volume = spec.vol;

  // per-band smoothing — bass snappier, treble faster
  smoothBass   += (spec.bass   - smoothBass)   * 0.25;
  smoothMid    += (spec.mid    - smoothMid)     * 0.2;
  smoothTreble += (spec.treble - smoothTreble)  * 0.3;
  smoothVol    += (volume      - smoothVol)     * 0.18;

  // peak
  if (smoothVol > peakDecay) {
    peakDecay = smoothVol;
    peak = Math.round(smoothVol * 100);
  } else {
    peakDecay *= 0.994;
  }

  // update UI
  if (micActive) {
    document.getElementById('volDisplay').textContent = Math.round(smoothVol * 100);
    document.getElementById('peakDisplay').textContent = peak;
    updateVU(smoothBass, smoothMid, smoothTreble);
  }

  // clear
  ctx.clearRect(0, 0, W, H);

  // very subtle bg glow when loud
  if (smoothVol > 0.3) {
    var bgGrad = ctx.createRadialGradient(cx, cy, 0, cx, cy, Math.min(W, H) * 0.6);
    bgGrad.addColorStop(0, 'rgba(229, 90, 28, ' + (smoothVol - 0.3) * 0.08 + ')');
    bgGrad.addColorStop(1, 'rgba(0,0,0,0)');
    ctx.fillStyle = bgGrad;
    ctx.fillRect(0, 0, W, H);
  }

  // idle movement even without mic
  var idleT = frame * 0.012;
  var idle = Math.sin(idleT) * 0.04 + 0.04;
  var dVol    = micActive ? smoothVol    : idle;
  var dBass   = micActive ? smoothBass   : idle * 0.8;
  var dMid    = micActive ? smoothMid    : idle * 0.6;
  var dTreble = micActive ? smoothTreble : idle * 0.4;

  switch (mode) {
    case 'blob': drawBlob(dVol, dBass, dMid, dTreble); break;
    case 'grid': drawGrid(dVol, dBass, dMid, dTreble); break;
    case 'ring': drawRing(dVol, dBass, dMid, dTreble); break;
    case 'wave': drawWave(dVol, dBass, dMid, dTreble); break;
  }
}

draw();
</script>
</body>
</html>
